@page "/pricing"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthProvider

<PageTitle>Pricing — UtilityMenu</PageTitle>
<HeadContent>
    <meta name="description" content="UtilityMenu pricing: free Core modules, Pro subscription, and bespoke Custom Modules built to your exact requirements." />
</HeadContent>

<div class="container py-6">
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold">Simple, Honest Pricing</h1>
        <p class="lead text-muted">Start free. Upgrade when you need more power. Or go fully bespoke.</p>

        <!-- Billing Toggle -->
        <div class="d-inline-flex align-items-center gap-3 mt-3">
            <span class="@(_isAnnual ? "text-muted" : "fw-semibold")">Monthly</span>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" @bind="_isAnnual" style="width:3rem;" />
            </div>
            <span class="@(_isAnnual ? "fw-semibold" : "text-muted")">
                Annual <span class="badge bg-success ms-1">Save 25%</span>
            </span>
        </div>
    </div>

    <div class="row g-4 justify-content-center mb-6">
        <div class="col-lg-4 col-md-6">
            <PricingCard
                Title="Free"
                Price="£0"
                Period="month"
                Description="Core modules for everyday Excel tasks."
                Features='@(new List<string> { "Get Last Row", "Get Last Column", "Unhide Rows", "Excel ribbon integration", "Free account required" })'
                CtaLabel="Download Free"
                CtaHref="/download" />
        </div>
        <div class="col-lg-4 col-md-6">
            <PricingCard
                Title="Pro"
                Price="@(_isAnnual ? "£45" : "£5")"
                Period="@(_isAnnual ? "year" : "month")"
                Description="Everything in Free, plus all Pro modules."
                Features='@(new List<string> { "All Free modules", "Advanced Data Tools", "Bulk Operations", "Data Export", "SQL Builder", "Up to 2 machines", "Priority support" })'
                CtaLabel="Subscribe Now"
                CtaHref="#"
                IsFeatured="true"
                OnCtaClick="@HandleSubscribeClick" />
        </div>
        <div class="col-lg-4 col-md-6">
            <PricingCard
                Title="Custom"
                Price="POA"
                Period="one-off build"
                Description="Bespoke Excel modules tailored to your exact workflow — scoped, built, and delivered to spec."
                Features='@(new List<string> {
                    "Fully scoped with you before build",
                    "Agreed number of functions",
                    "File cleaning &amp; data automation",
                    "Lab workflows &amp; sample tracking",
                    "System integrations (APIs / databases)",
                    "Domain-specific tools",
                    "Delivered as a dedicated ribbon module"
                })'
                CtaLabel="Request Custom Module"
                CtaHref="/contact?subject=Request+Custom+Module"
                HeaderLabel="BESPOKE"
                HeaderClass="bg-warning text-dark"
                ExtraCardClass="border-warning shadow-sm"
                CtaBtnClass="btn-warning text-dark fw-semibold" />
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(_message))
    {
        <AlertBanner Message="@_message" Type="@_messageType" />
    }

    <!-- Comparison Table -->
    <div class="mt-5">
        <h2 class="text-center fw-bold mb-4">Feature Comparison</h2>
        <div class="table-responsive">
            <table class="table table-bordered text-center">
                <thead class="table-dark">
                    <tr>
                        <th class="text-start">Feature</th>
                        <th>Free</th>
                        <th>Pro</th>
                        <th>Custom</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var row in _comparisonRows)
                    {
                        <tr>
                            <td class="text-start">@row.Feature</td>
                            <td>@((MarkupString)(row.Free ? "<i class='bi bi-check-lg text-success'></i>" : "<i class='bi bi-x-lg text-danger'></i>"))</td>
                            <td>@((MarkupString)(row.Pro ? "<i class='bi bi-check-lg text-success'></i>" : "<i class='bi bi-x-lg text-danger'></i>"))</td>
                            <td>@((MarkupString)row.CustomCell)</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <p class="text-muted small text-center mt-2">
            * Custom Modules are scoped individually — the exact features delivered are agreed during a free scoping call.
        </p>
    </div>

    <!-- Custom Modules Callout -->
    <div class="card border-warning mt-5">
        <div class="card-body p-4">
            <div class="row align-items-center g-3">
                <div class="col-md-8">
                    <h4 class="fw-bold mb-1"><i class="bi bi-puzzle-fill text-warning me-2"></i>Custom Modules — Built for You</h4>
                    <p class="text-muted mb-0">
                        Need a workflow that Core or Pro don't cover? We scope, build, and deliver a bespoke
                        Excel module around your exact requirements — file cleaning, lab automation, API integrations,
                        and more. One-off fee, no ongoing subscription.
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a href="/contact?subject=Request+Custom+Module" class="btn btn-warning fw-semibold px-4">
                        Request a Custom Module <i class="bi bi-arrow-right ms-2"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- FAQ -->
    <div class="mt-5">
        <h2 class="text-center fw-bold mb-4">Frequently Asked Questions</h2>
        <div class="accordion" id="faqAccordion">
            @foreach (var (faq, i) in _faqs.Select((f, i) => (f, i)))
            {
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button @(i == 0 ? "" : "collapsed")" type="button"
                                data-bs-toggle="collapse" data-bs-target="#faq@(i)">
                            @faq.Question
                        </button>
                    </h2>
                    <div id="faq@(i)" class="accordion-collapse collapse @(i == 0 ? "show" : "")">
                        <div class="accordion-body text-muted">@faq.Answer</div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private bool _isAnnual;
    private string? _message = null;
    private string _messageType = "info";

    private readonly List<ComparisonRow> _comparisonRows =
    [
        new("Get Last Row",        true,  true,  "<i class='bi bi-check-lg text-success'></i>"),
        new("Get Last Column",     true,  true,  "<i class='bi bi-check-lg text-success'></i>"),
        new("Unhide Rows",         true,  true,  "<i class='bi bi-check-lg text-success'></i>"),
        new("Advanced Data Tools", false, true,  "<i class='bi bi-check-lg text-success'></i>"),
        new("Bulk Operations",     false, true,  "<i class='bi bi-check-lg text-success'></i>"),
        new("Data Export",         false, true,  "<i class='bi bi-check-lg text-success'></i>"),
        new("SQL Builder",         false, true,  "<i class='bi bi-check-lg text-success'></i>"),
        new("Up to 2 machines",    false, true,  "<span class='text-muted small'>Scoped*</span>"),
        new("Priority support",    false, true,  "<i class='bi bi-check-lg text-success'></i>"),
        new("Bespoke functions",   false, false, "<i class='bi bi-check-lg text-success'></i>"),
        new("One-off build fee",   false, false, "<i class='bi bi-check-lg text-success'></i>")
    ];

    private readonly List<FaqItem> _faqs =
    [
        new("How many machines can I use with Pro?", "Each Pro licence supports up to 2 active machines. You can deactivate a machine from your dashboard to activate a new one."),
        new("Can I cancel at any time?", "Yes, you can cancel your subscription at any time from your billing dashboard. You'll retain access until the end of the current period."),
        new("Is there a refund policy?", "We offer a 14-day refund for new subscriptions. Contact support within 14 days of purchase."),
        new("Do I need an account to use the free version?", "Yes — a free account is required to download UtilityMenu. Accounts let you manage your modules, receive updates, and handle licensing in one place. Sign up takes under a minute and no credit card is needed."),
        new("How does the Custom Module process work?", "Start by clicking 'Request Custom Module' and sending us a brief description of what you need. We'll arrange a short scoping call to agree on the functions, timelines, and a fixed build fee — before any work begins. Once complete, your module is delivered as an Excel ribbon add-in.")
    ];

    private async Task HandleSubscribeClick()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        if (!authState.User.Identity?.IsAuthenticated ?? true)
        {
            Nav.NavigateTo($"/account/register?returnUrl={Uri.EscapeDataString("/pricing")}");
            return;
        }
        Nav.NavigateTo("/pricing/checkout");
    }

    private record ComparisonRow(string Feature, bool Free, bool Pro, string CustomCell);
    private record FaqItem(string Question, string Answer);
}
