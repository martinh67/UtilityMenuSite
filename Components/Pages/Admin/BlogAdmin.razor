@page "/admin/blog"
@rendermode InteractiveServer
@layout AdminLayout
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]
@inject IBlogService BlogService
@inject NavigationManager Nav

<PageTitle>Blog Admin â€” UtilityMenu</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-0">Blog Posts</h2>
    <a href="/admin/blog/new" class="btn btn-primary">
        <i class="bi bi-plus-lg me-1"></i>New Post
    </a>
</div>

@if (!string.IsNullOrWhiteSpace(_message))
{
    <AlertBanner Message="@_message" Type="@_messageType" />
}

@if (_loading)
{
    <LoadingSpinner />
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Title</th>
                    <th>Category</th>
                    <th>Status</th>
                    <th>Published</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var post in _posts)
                {
                    <tr>
                        <td><strong>@post.Title</strong></td>
                        <td><span class="badge bg-light text-dark">@post.Category.Name</span></td>
                        <td>
                            <span class="badge @(post.IsPublished ? "bg-success" : "bg-secondary")">
                                @(post.IsPublished ? "Published" : "Draft")
                            </span>
                        </td>
                        <td class="small text-muted">@post.PublishedAt?.ToString("MMM d, yyyy")</td>
                        <td>
                            <a href="/admin/blog/@post.PostId/edit" class="btn btn-sm btn-outline-primary me-1">Edit</a>
                            @if (!post.IsPublished)
                            {
                                <button class="btn btn-sm btn-outline-success me-1" @onclick="() => PublishPost(post.PostId)">Publish</button>
                            }
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeletePost(post.PostId)">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<Data.Models.BlogPost> _posts = new();
    private string? _message;
    private string _messageType = "info";
    private bool _loading = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        await LoadPostsAsync();
    }

    private async Task LoadPostsAsync()
    {
        _posts = await BlogService.GetAllForAdminAsync();
        _loading = false;
        StateHasChanged();
    }

    private async Task PublishPost(Guid postId)
    {
        await BlogService.PublishPostAsync(postId);
        await LoadPostsAsync();
        _message = "Post published.";
        _messageType = "success";
    }

    private async Task DeletePost(Guid postId)
    {
        await BlogService.DeletePostAsync(postId);
        await LoadPostsAsync();
        _message = "Post deleted.";
        _messageType = "warning";
    }
}
